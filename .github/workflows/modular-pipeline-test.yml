name: Modular Pipeline CI Test

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  prepare-data:
    name: Prepare Test Data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
    # Using uv for faster installs
      - name: Install uv
        run: pip install uv

      - name: Cache uv
        uses: actions/cache@v4
        with:
            path: ~/.cache/uv
            key: ${{ runner.os }}-uv-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies fast
        run: uv pip install --system -r requirements.txt


      - name: Prepare dummy CI data
        run: python scripts/prepare_ci_data.py

      - name: Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-data
          path: data/raw/
          retention-days: 1

  run-full-pipeline:
    name: Run Full Modular Pipeline
    runs-on: ubuntu-latest
    needs: prepare-data

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
    # Using uv for faster installs
      - name: Install uv
        run: pip install uv

      - name: Cache uv
        uses: actions/cache@v4
        with:
            path: ~/.cache/uv
            key: ${{ runner.os }}-uv-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies fast
        run: uv pip install --system -r requirements.txt



      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: data/raw/

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

      - name: Clean Great Expectations config
        run: rm -rf great_expectations || true

      - name: Run Load stage
        run: python scripts/modular_pipeline.py --stages load

      - name: Run Validate stage
        run: python scripts/modular_pipeline.py --stages validate

      - name: Run Preprocess stage
        run: python scripts/modular_pipeline.py --stages preprocess

      - name: Run Feature stage
        run: python scripts/modular_pipeline.py --stages features

      - name: Run Encode stage
        run: python scripts/modular_pipeline.py --stages encode

      - name: Run Optuna stage (minimal)
        run: python scripts/modular_pipeline.py --stages optuna --n-trials 5

      - name: Run Train stage (minimal)
        run: python scripts/modular_pipeline.py --stages train --n-trials 5 --n-runs 2

      - name: Run Save stage
        run: python scripts/modular_pipeline.py --stages save

      - name: Verify outputs
        run: |
          echo "Checking outputs..."
          ls -lh outputs || true
          ls -lh models || true
          ls -lh mlruns || true

      - name: Upload pipeline artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifacts
          path: |
            outputs/
            models/
            mlruns/
          retention-days: 1

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: run-full-pipeline
    if: always()

    steps:
      - name: Done
        run: |
          echo "======================================"
          echo "  MODULAR PIPELINE CI FINISHED"
          echo "======================================"
          echo "All stages executed successfully."

